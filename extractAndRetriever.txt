import android.media.MediaExtractor;
import android.media.MediaFormat;
import android.media.MediaMuxer;
import android.media.MediaCodec;
import android.media.MediaMetadataRetriever;
import android.util.Log;
import java.io.IOException;
import java.nio.ByteBuffer;

public class VideoTrimmer {

    public static void trimVideo(String inputPath, String outputPath, long startMs, long endMs) throws IOException {
        MediaExtractor videoExtractor = new MediaExtractor();
        videoExtractor.setDataSource(inputPath);
        MediaExtractor audioExtractor = new MediaExtractor();
        audioExtractor.setDataSource(inputPath);

        int videoTrackIndex = -1;
        int audioTrackIndex = -1;
        for (int i = 0; i < videoExtractor.getTrackCount(); i++) {
            MediaFormat format = videoExtractor.getTrackFormat(i);
            String mime = format.getString(MediaFormat.KEY_MIME);
            if (mime.startsWith("video/")) {
                videoTrackIndex = i;
            } else if (mime.startsWith("audio/")) {
                audioTrackIndex = i;
            }
        }

        if (videoTrackIndex == -1) {
            throw new IllegalArgumentException("No video track found in " + inputPath);
        }

        videoExtractor.selectTrack(videoTrackIndex);
        if (audioTrackIndex != -1) {
            audioExtractor.selectTrack(audioTrackIndex);
        }

        MediaMuxer muxer = new MediaMuxer(outputPath, MediaMuxer.OutputFormat.MUXER_OUTPUT_MPEG_4);
        int outputVideoTrack = muxer.addTrack(videoExtractor.getTrackFormat(videoTrackIndex));
        int outputAudioTrack = -1;
        if (audioTrackIndex != -1) {
            outputAudioTrack = muxer.addTrack(audioExtractor.getTrackFormat(audioTrackIndex));
        }
        muxer.start();

        // Using MediaMetadataRetriever to get keyframes
        MediaMetadataRetriever retriever = new MediaMetadataRetriever();
        retriever.setDataSource(inputPath);

        long videoStartTime = retriever.extractMetadataLong(MediaMetadataRetriever.METADATA_KEY_VIDEO_FRAME);
        long videoEndTime = retriever.extractMetadataLong(MediaMetadataRetriever.METADATA_KEY_VIDEO_FRAME);

        startMs = Math.max(startMs, videoStartTime);
        endMs = Math.min(endMs, videoEndTime);

        // Trim the video track
        videoExtractor.seekTo(startMs * 1000, MediaExtractor.SEEK_TO_PREVIOUS_SYNC);
        MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo();
        ByteBuffer buffer = ByteBuffer.allocate(1024 * 1024);

        while (true) {
            bufferInfo.offset = 0;
            bufferInfo.size = videoExtractor.readSampleData(buffer, 0);
            if (bufferInfo.size < 0) {
                break;
            }

            long sampleTime = videoExtractor.getSampleTime();
            if (sampleTime > endMs * 1000) {
                break;
            }

            bufferInfo.presentationTimeUs = sampleTime;
            bufferInfo.flags = videoExtractor.getSampleFlags();
            muxer.writeSampleData(outputVideoTrack, buffer, bufferInfo);
            videoExtractor.advance();
        }

        // Trim the audio track if it exists
        if (audioTrackIndex != -1) {
            audioExtractor.seekTo(startMs * 1000, MediaExtractor.SEEK_TO_CLOSEST_SYNC);

            while (true) {
                bufferInfo.offset = 0;
                bufferInfo.size = audioExtractor.readSampleData(buffer, 0);
                if (bufferInfo.size < 0) {
                    break;
                }

                long sampleTime = audioExtractor.getSampleTime();
                if (sampleTime > endMs * 1000) {
                    break;
                }

                bufferInfo.presentationTimeUs = sampleTime;
                bufferInfo.flags = audioExtractor.getSampleFlags();
                muxer.writeSampleData(outputAudioTrack, buffer, bufferInfo);
                audioExtractor.advance();
            }
        }

        muxer.stop();
        muxer.release();
        videoExtractor.release();
        if (audioTrackIndex != -1) {
            audioExtractor.release();
        }
    }
}
